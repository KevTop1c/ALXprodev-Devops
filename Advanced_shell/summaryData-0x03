#!/bin/bash

# Pokémon Report Generator
DATA_DIR="pokemon_data"
REPORT_FILE="pokemon_report.csv"
TEMP_FILE=$(mktemp)

# Check if directory exists
if [ ! -d "$DATA_DIR" ]; then
    echo "Error: $DATA_DIR directory was not found. Please run the batch script first." >&2
    exit 1
fi

# Check if there are json files
if [ -z "$(ls -A "$DATA_DIR"/*.json 2>/dev/null)" ]; then
    echo "Error: No JSON files found in $DATA_DIR" >&2
    exit 1
fi

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$REPORT_FILE"

# Process each JSON file and extract data
for json_file in "$DATA_DIR"/*.json; do 
    if [ -f "$json_file" ]; then
        # Extract data using jq and format for CSV
        jq -r '"\(.name),\(.height / 10),\(.weight / 10)"' "$json_file" >> "$TEMP_FILE"
    fi
done

# Use sed to clean and format the data before sorting
sed -i 's/^[[:space:]]*//; s/[[:space:]]*$//' "$TEMP_FILE"  # Remove leading/trailing whitespace
sed -i '/^$/d' "$TEMP_FILE"  # Remove empty lines

# Sort the data by Pokémon name and append to CSV
sort "$TEMP_FILE" >> "$REPORT_FILE"

# Use sed to ensure proper CSV formatting in the final file
sed -i 's/,,*/,/g' "$REPORT_FILE"  # Remove multiple commas
sed -i '/^$/d' "$REPORT_FILE"      # Remove empty lines from final CSV

# Calculate averages using awk
awk -F',' '
NR > 1 {
    total_height += $2
    total_weight += $3
    count ++
}
END {
    if (count > 0) {
        avg_height = total_height / count
        avg_weight = total_weight / count
        printf "\nAverage Height: %.2f m\n", avg_height
        printf "Average Weight: %.2f kg\n", avg_weight
    }
}
' "$REPORT_FILE"

# Clean up temp file
rm -f "$TEMP_FILE"

echo "CSV Report generated at: $REPORT_FILE"